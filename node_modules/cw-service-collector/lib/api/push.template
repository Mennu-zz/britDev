
var Collector = require('% collectorDir %/api')()

process.on('message', function (msg) {

  var req = msg
  var res
  var resultSent = false

  if (!resultSent && (typeof(accessControl) !== 'undefined') && !accessControl(req)) {
    res = {
      id: req.id,
      code: 403,
      time: Date.now(),
      message: 'Forbidden'
    }
    process.send(JSON.stringify(res))
    resultSent = true
  }

  if (!resultSent && (typeof(accessControl) !== 'undefined') && !dataValidation(req)) {
    res = {
      id: req.id,
      code: 422,
      time: Date.now(),
      message: 'Invalid input'
    }
    process.send(JSON.stringify(res))
    resultSent = true
  }

  // all clear
  if (!resultSent) {

    acceptData(req).then(

      // success
      function (data) {
        console.log(msg)
        res = {
          id: req.id,
          code: 200,
          time: Date.now(),
          message: data
        }
        console.log('CALLED acceptData')
        process.send(JSON.stringify(res))
        resultSent = true
      },

      function (err) {
        res = {
          id: req.id,
          code: 500,
          time: Date.now(),
          message: 'Internal Server Error'
        }
        process.send(JSON.stringify(res))
        resultSent = true
      }
    )

  }

})

/************* developer code after this line **************/
